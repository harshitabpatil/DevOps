pipeline {
    agent any
    environment {
        TARGET_SERVER = 'ubuntu@54.89.171.67' // EC2 user and IP
        FRONTEND_DIR = '/home/ubuntu/DevOps/KTMC_Website_Frontend-dev-server' // Target folder on EC2
        FRONTEND_SERVICE_NAME = 'KTMC_Website_Frontend' // PM2 service name
        SSH_KEY = '/var/lib/jenkins/.ssh/id_rsa' // Path to Jenkins SSH private key
    }
    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }
        stage('Deploy Frontend to EC2') {
            steps {
                script {
                    // SCP Frontend code to EC2 (excluding .git and Jenkinsfile)
                    sh """
                    scp -o StrictHostKeyChecking=no -i ${SSH_KEY} -r ./KTMC_Website_Frontend-dev-server/* ${TARGET_SERVER}:${FRONTEND_DIR}/
                    """
                    
                    // SSH into EC2 and deploy
                    sh """
                    ssh -o StrictHostKeyChecking=no -i ${SSH_KEY} ${TARGET_SERVER} << 'EOF'
set -e  # Stop if any command fails
cd ${FRONTEND_DIR}
rm -rf node_modules package-lock.json
npm install express@4 --legacy-peer-deps
npm install --legacy-peer-deps
npm run build
pm2 restart ${FRONTEND_SERVICE_NAME} || pm2 start server.js --name "${FRONTEND_SERVICE_NAME}"
EOF
                    """
                }
            }
        }
    }
    post {
        success {
            echo 'Frontend Deployed and Service Restarted Successfully!'
        }
        failure {
            echo 'Frontend Deployment Failed. Please check logs for details.'
        }
    }
}
